## Setup instructions
1. Clone repository.
2. Run `docker compose up --build`


# API description

## Authorization

To use authorization in Swagger (FastAPI docs), the auth_token generated by the handles in this category is to be inserted in both Bearers in the upper right corner on the docs page (`/docs`).
For authorization in API, Header Authorization is utilized.

### POST /auth/register
Register a user with login and password. Login must be unique.
The resulting auth_token is used to authorize in BOTH Bearers.

Input: login, password  
Output: auth_token

Example:
```
curl -X 'POST' \  
'http://localhost:8000/auth/register' \  
-H 'accept: application/json' \  
-H 'Content-Type: application/json' \  
-d '{  
"login": "login",  
"password": "pass"  
}'
```

Example Response:
```
{
  "token": "token"
}
```

### POST /auth/login
Login an existing user.
The resulting auth_token is used for authorization.

Input: login, password  
Output: auth_token

Example:
```
curl -X 'POST' \
  'http://localhost:8000/auth/login' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "login": "login",
  "password": "pass"
}'
```

Example Response:
```
{
  "token": "token"
}
```

## Links

### POST /links/shorten
Create a short link for a provided long link.  
You can choose the short link with custom_alias parameter. However, if this link is already taken, you will receive a 400 Exception.  
If the expiration date for the short link is not provided, it will be set in a week. Expiration date is to be provided in ISO 8601 format.

You may create links while you are unauthorized, but to delete or update links you must be authorized. Moreover, if you have created a link, while you are unauthorized, and then you logged in, you are still incapable of changing that link.

Input: url  
Output: short_code, custom_alias (optional), expires_at (optional)

Unauthorized example:
```
curl -X 'POST' \
  'http://localhost:8000/links/shorten?url=https%3A%2F%2Fwww.google.ru%2F%3Fhl%3Dru&custom_alias=googoo' \
  -H 'accept: application/json' \
  -d ''
```

Example Response:
```
{
  "short_code": "googoo",
  "expires_at": "2025-03-31T14:51:21.701085"
}
```

Authorized example:
```
curl -X 'POST' \
  'http://localhost:8000/links/shorten?url=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F17780291%2Fpython-socket-error-errno-98-address-already-in-use&custom_alias=stacku&expires_at=2025-03-25%2017%3A17' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer token' \
  -d ''
```

Example Response:
```
{
  "short_code": "stacku",
  "expires_at": "2025-03-25T17:17:00"
}
```


### GET /links/{short_code}

Get Redirect Response to the binded long url.

Input: None  
Output: Redirect Response

Example:
```
curl -X 'GET' \
  'http://localhost:8000/links/stacku' \
  -H 'accept: application/json'
```


### DELETE /links/{short_code}
Delete created short link. You can only delete urls that you created while authorized.

Input: None  
Output: None

Example:
```
curl -X 'DELETE' \
  'http://localhost:8000/links/stacku' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer token' 
```

### PUT /links/{short_code}
Update a created short link with a new url. You can only update urls that you created while authorized.

Input: url  
Output: None

Example:
```
curl -X 'PUT' \
  'http://localhost:8000/links/stacku' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer token' \
  -H 'Content-Type: application/json' \
  -d '{
  "url": "https://stackoverflow.com/questions/969285/how-do-i-translate-an-iso-8601-datetime-string-into-a-python-datetime-object"
}' 
```

Example Response:
```
{
  "short_code": "stacku"
}
```

### GET /links/{short_code}/stats
Get statistics for the short url.  
The statistics include: the amount of times used, the amount of registered users that used this link, last usage datetime and when was this link created.

Example:
```
curl -X 'GET' \
  'http://localhost:8000/links/stacku/stats' \
  -H 'accept: application/json'
```

Example Response:
```
{
  "request_count": 1,
  "last_request": "2025-03-24T15:18:35.222218",
  "reg_user_count": 1,
  "created_at": "2025-03-24T15:09:38.985373"
}
```


### GET /search

Search a short url for the provided url.  
If it exists, the response contains its short code, otherwise - a 404 Exception. 

Input: url
Output: short_code

Example:
```
curl -X 'GET' \
  'http://localhost:8000/search?original_url=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F969285%2Fhow-do-i-translate-an-iso-8601-datetime-string-into-a-python-datetime-object' \
  -H 'accept: application/json'
```




# Database description
There are 2 options for the database: SQLite and PostgreSQL. The default database is PostgreSQL. To use SQLite, `./link_app/db.py` is to be swapped with `./link_app/sqlite_db.py`. 
The schemas for tables in the databases is the same.

There are 3 tables: Links, Users, Requests.  
### Links - All active and inactive links
    link_id SERIAL PRIMARY KEY
    short_code TEXT NOT NULL
    url TEXT NOT NULL      
    user_id INT - ID of the user that created this link, None if unauthorized.
    created_at TIMESTAMP  
    expires_at TIMESTAMP
    active INT(BOOL) - 0 or 1

### Users - Registered Users
    user_id SERIAL PRIMARY KEY
    login TEXT UNIQUE NOT NULL 
    password TEXT NOT NULL
    created_at TIMESTAMP NOT NULL

### Requests - Statistics of link usage
    request_id SERIAL PRIMARY KEY
    link_id INT NOT NULL REFERENCES Links(link_id)
    request_dt TIMESTAMP NOT NULL
    user_id INT


Links are checked with a cron script `./cron_clear_db/clear_expired_links.py` every 24 hours: all expired links are made inactive.


